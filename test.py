import os
import ember
import lightgbm as lgb

'''
bin_root = 'E:/VirusShare_00177/'
img_root = './img'
if not os.path.exists(img_root):
    os.mkdir(img_root)

cnt = 0
for bin_name in os.listdir(bin_root):
    bin_path = os.path.join(bin_root, bin_name)
    if os.path.isfile(bin_path):
        bin_to_img(bin_path, os.path.join(img_root, str(cnt).zfill(2) + '.jpg'))
    cnt += 1
    if cnt == 5:
        break
'''

'''
import lief
binary = lief.parse('D:/dataset/malware/VirusShare_00177/VirusShare_203342ded64565a89eb10f6b3b829d33')
print('done')
'''

'''
lgbm_model = lgb.Booster(model_file="D:/dataset/malware/ember2018/ember_model_2018.txt")
putty_data = open("D:/dataset/malware/VirusShare_00177/VirusShare_114bfc56ecc01a44ce23398958607fd0", "rb").read()
print(ember.predict_sample(lgbm_model, putty_data))
'''
import pefile
import shutil
import torch
import pickle
import binascii


def main():
    cnt = 0
    walk_root = 'D:\\Win10Driver'
    for root, dirs, files in os.walk(walk_root):
        for file_name in files:
            file_path = os.path.join(root, file_name)
            if os.path.getsize(file_path) > 20000 * 1024:
                continue

            try:
                binary = pefile.PE(file_path)
                del binary
                cnt += 1
            except:
                continue

            if os.path.exists(os.path.join('data', 'benign', file_name)):
                continue
            else:
                shutil.copyfile(file_path, os.path.join('data', 'benign', file_name))
    print('Found:', cnt)


if __name__ == '__main__':
    main()
